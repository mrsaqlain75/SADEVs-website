<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign In </title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="index-styles.css">
    <link rel="stylesheet" href="signup.css">
    <style>
        .wrapper2{
            display:none;
        }
        .wrapper3{
          display: none;
        }
    </style>
</head>
<body>
    <div class="pre-header">
        <p>This website is under-development. Please support us with you precious <a href="">DONATIONS</a></p>
    </div>
    <header>
      <a href="index.html"><img src="Images/sadevs-logo.png" alt="company-logo"></a>
      <div class="menu-btn">
          <i id="hamburger" class="fas fa-bars"></i>
      </div>
      <ul class="menu">
          <li><a href="index.html">Home</a></li>
          <li><a href="writeearn.html">Write & Earn</a></li>
          <li><a href="contact.html">Contact</a></li>
          <li><a href="about.html">About</a></li>
          <li id="login-btn" style="margin-left: auto;"><a href="signin.html">Sign In</a></li>
          <li id="signup-btn"><a href="signup.html">Sign Up</a></li>
          <li style="margin-left: auto; background-color: #00abe4; color:#E9F1FA" id="user-profile" style="display:none;">
            <a href="#" id="user-icon"><i class="fa-solid fa-user"></i></a>
            <ul id="user-dropdown" style="display:none;">
              <li><a href="post-article.html">Post an article</a></li>
              <li><a href="profile.html">Your Profile</a></li>
              <li><a href="edit-profile.html">Edit Profile</a></li>
              <li><a href="change-password.html">Change Password</a></li>
              <li><a href="payment-methods.html">Payment Methods</a></li>
              <li><a href="#" id="logout">Logout</a></li>
            </ul>
          </li>
      </ul>
  </header>
    <div class="wrapper wrapper1" id="wrapper-form">
        <h2 id="head">Sign In</h2>
        <form id = "login_form">
          <div class="input-box">
            <input type="text" id="email" placeholder="Enter your email" required>
          </div>
          <div class="input-box">
            <input type="password" id="pass" placeholder="Enter your password" required>
          </div>
          <div class="text">
            <h3  style="width: 100%; text-align: left;" ><a id="forgot-pass" href="#">Forgot Password</a></h3>
          </div>
          <div class="input-box button">
            <input type="Submit" id="submit_btn" value="Sign In">
          </div>
          <div class="text">
            <h3>Don't have an account? <a href="Signup.html">Signup now</a></h3>
          </div>
        </form>
      </div>
      <div class="wrapper wrapper2" id="wrapper-forgot">
        <h2 id="head">Recover your password</h2>
        <form id = "forget_form">
          <div class="input-box">
            <input type="text" id="rec-email" placeholder="Enter your email" required>
          </div>
          <div class="input-box button">
            <input type="Submit" id="rec-submit-btn" value="Send">
          </div>
        </form>
      </div>
      <div class="wrapper wrapper3" id="wrapper-verify">
        <h2 id="head">Recover your password</h2>
        <form id = "verify_form">
          <div class="input-box">
            <input type="text" id="verify-code" placeholder="Verification code" required>
          </div>
          <div class="input-box">
            <input type="text" id="rec-pass" placeholder="New Password" required>
          </div>
          <div class="input-box">
            <input type="text" id="rec-cpass" placeholder="Confirm Password" required>
          </div>
          <div class="input-box button">
            <input type="Submit" id="rec-change-btn" value="Change">
          </div>
        </form>
      </div>

      <script>
        document.addEventListener('DOMContentLoaded', function() {
            const menuBtn = document.querySelector('.menu-btn');
            const menu = document.querySelector('.menu');
            
            menuBtn.addEventListener('click', function() {
                menu.classList.toggle('active');
            });
        });
    </script>
    <script>
      document.getElementById("login_form").addEventListener('submit', async function(event){
    event.preventDefault();

    // Getting values from the input boxes
    const email = document.getElementById('email').value;
    const pass = document.getElementById('pass').value;

    try {
        // Sending login request
        const response = await fetch('/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, pass })
        });

        // Checking if the response is okay
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();

        window.alert(result.message);

        // Fetching session data
        const sessionResponse = await fetch('/session-data');
        if (!sessionResponse.ok) {
            throw new Error(`Session error! status: ${sessionResponse.status}`);
        }
        const sessionResult = await sessionResponse.json();

        // Alerting session data before redirecting
        window.alert(`Session Data: ${JSON.stringify(sessionResult.sessionData)}`);
        // Redirect to the next webpage
        window.location.href = "index.html";

    } catch (error) {
        console.error("An error occurred:", error);
        window.alert("An error occurred: " + error.message);
    }
});

document.getElementById("forgot-pass").addEventListener('click', async function(){
    document.getElementById("wrapper-form").style.display = "none";
    document.getElementById("wrapper-forgot").style.display = "block";
    recBtn = document.getElementById('rec-submit-btn'); 
    recBtn.addEventListener('click', async function(){
      const email = document.getElementById('rec-email').value;
      const response = await fetch('/send-verification-code-for', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email })
            });
      const result = await response.json();
      if(result.success){
            document.getElementById("wrapper-forgot").style.display = "none";
            document.getElementById("wrapper-verify").style.display = "block"
            document.getElementById("rec-change-btn").addEventListener('click',async function(){
            const code = document.getElementById('verify-code').value;
            const recPass = document.getElementById('rec-pass').value;
            const recCpass = document.getElementById('rec-cpass').value;
            if (recPass.trim() === '') {
            alert("Enter you password");
          } else {
            if(!(recPass === recCpass)){
              alert("Passwords are not same");
            }
            else{
              
            const response = await fetch('/verify-code-for', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, code })
            });
            const result = await response.json();
            if (result.success){
              //Code is verified, now changing the password.
              const response = await fetch('/update-password',{
                method : 'POST',
                headers : {
                  'Content-Type' : 'application/json',
                },
                body : JSON.stringify({email,recCpass})
              });
              const result = await response.json();
              if(result.success){
                alert("Password Updated Successfully");
                window.location = "index.html";
              }
              else{
                console.log("Error", result.message);
              }
            }
            else{
              alert("Invalid verification code");
            }
            
          }
          }
            });    
          }
          else{
            console.log("Error sending verification code");
          }

          });
});


    </script>
</body>
</html>